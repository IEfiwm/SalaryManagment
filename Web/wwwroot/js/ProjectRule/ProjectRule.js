$('.drag').draggable({
    appendTo: 'body',
    helper: 'clone',
    revert: 'invalid'
});

$('#dropzone').droppable({
    activeClass: 'active',
    hoverClass: 'hover',
    accept: ".drag", // Reject clones generated by sortable
    drop: function (e, ui) {

        var draggedFieldId = $(ui.draggable).prop('id');
        var value = draggedFieldId;
        var draggedId = $(ui.draggable).parent().parent().prop('id');
        var draggedBefore = $('#dropzone').children().last().attr('name')
        var draggedBeforeId = $('#dropzone').children().last().find('input[type="hidden"]').attr('value')

        if (draggedBefore == undefined && draggedId == 'Calc' && draggedFieldId != '(') {
            swal('امکان اضافه کردن عملگر در ابتدای فرمول وجود ندارد');
            return;
        }

        if (draggedId == draggedBefore &&
            ((draggedFieldId != ')' && draggedFieldId != '(')
                && (draggedBeforeId != ')' && draggedBeforeId != '('))) {
            swal('لطفا در بین عوامل از عملگر استفاده کنید.');
            return;
        }

        if (draggedFieldId == 'dynamicNumber') {
            if ($('#dynamicNumber input').val() == '') {
                swal('لطفا فیلد عدد را پر کنید.');
                return;
            }
            value = $('#dynamicNumber input').val();
            $('#dynamicNumber input').val('');
        }

        $elDiv1 = $(`<div class="col-md-3 pl-0"></div>`);
        $elDiv1.append($('<button type="button" title="حذف" class="btn btn-default btn-xs remove"><small class="fa fa-times text-danger"></small></button>')
            .click(function () {
                if ($(this).parent().parent().parent().next().length == 0)
                    $(this).parent().parent().parent().detach();
                else
                    swal(' امکان حذف عملگر/عوامل در بین فرمول وجود ندارد، لطفا از انتها اقدام به حذف کنید');
            })
        );

        //ui.draggable.draggable({ disabled: true });
        //setTimeout(function () {
        //    $(ui.draggable).draggable("destroy");
        //}, 0);

        if (draggedId == 'CalcProp') {

            var $elDiv = $('<div class="drop-item row"><div class="col-md-9 pr-1"><label class="pt-2">' + value + '</label></div></div>');

            if (draggedFieldId != 'dynamicNumber') {
                value = '[' + value + ']';
            }
            var $el = $(`<div class="col-md-2" name="${draggedId}"><input type="hidden" value="${value}" name="RuleList" /></div>`);
            $elDiv.append($elDiv1);
            $el.append($elDiv);
            $(this).append($el);
        }
        else {
            var $el = $(`<div class="col-md-1" name="${draggedId}"><input type="hidden" value="${value}" name="RuleList" /></div>`);
            var $elDiv = $('<div class="drop-item row"><div class="col-md-3 pr-3"><h5 class="pt-2">' + value + '</h5></div></div>');
            $elDiv.append($elDiv1);
            $el.append($elDiv);
            $(this).append($el);
        }


    }
})

function Delete(This) {
    if ($(This).parent().parent().parent().next().length == 0)
        $(This).parent().parent().parent().detach();
    else
        swal(' امکان حذف عملگر/عوامل در بین فرمول وجود ندارد، لطفا از انتها اقدام به حذف کنید');

}
$('#form').on('submit', function (e) {
    var draggedBefore = $('#dropzone').children().last().attr('name')
    var draggedId = $('#dropzone').children().last().find('input[type="hidden"]').attr('value')
    if (draggedBefore == 'Calc' && draggedId != '%' && draggedId != ')') {
        swal('امکان وجود عملگر در انتهای فرمول وجود ندارد.');
        e.preventDefault();
        return;
    }
    if ($('#dropzone').children().find('input[type="hidden"][value="("]').length
        !=
        $('#dropzone').children().find('input[type="hidden"][value=")"]').length) {
        swal('تعداد پرانتز های باز و بسته یکسان نیست. لطفا فرمول را ویرایش کنید');
        e.preventDefault();
        return;
    }

});